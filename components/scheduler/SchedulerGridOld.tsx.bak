'use client';

import { useMemo, useState, useRef } from 'react';
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  ColumnDef,
  SortingState,
  flexRender,
} from '@tanstack/react-table';
import { useVirtualizer } from '@tanstack/react-virtual';
import { Teacher, CourseGroup, DivisionConfig, Assignment } from '@/types/scheduler';
import { usePersistedSchedulerState } from '@/hooks/usePersistedSchedulerState';
import { getDivisionColor } from '@/utils/colors';
import clsx from 'clsx';

interface SchedulerGridProps {
  teachers: Teacher[];
  courseGroups: CourseGroup[];
  divisions: DivisionConfig[];
  onAssignmentUpdate: (teacherId: string, assignments: Assignment[]) => void;
}

export default function SchedulerGrid({
  teachers,
  courseGroups,
  divisions,
  onAssignmentUpdate,
}: SchedulerGridProps) {
  const { state, toggleCourseGroup, toggleDivision } = usePersistedSchedulerState();
  const [sorting, setSorting] = useState<SortingState>([]);

  // Filter teachers based on collapsed divisions
  const visibleTeachers = useMemo(() => {
    return teachers.filter(
      teacher => !state.collapsedDivisions.includes(teacher.division)
    );
  }, [teachers, state.collapsedDivisions]);

  // Define static columns
  const staticColumns = useMemo<ColumnDef<Teacher>[]>(() => [
    {
      accessorKey: 'name',
      header: 'Teacher',
      size: 200,
      cell: ({ row }) => (
        <div className="font-medium text-gray-900">{row.original.name}</div>
      ),
    },
    {
      accessorKey: 'division',
      header: 'Division',
      size: 80,
      cell: ({ row }) => (
        <div className={clsx(
          'rounded px-2 py-1 text-center text-xs font-semibold',
          row.original.division === 'MS' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
        )}>
          {row.original.division}
        </div>
      ),
    },
    {
      accessorKey: 'otherRole',
      header: 'Other Role',
      size: 150,
      cell: ({ row }) => (
        <div className="text-sm text-gray-600">{row.original.otherRole || '-'}</div>
      ),
    },
    {
      accessorKey: 'maxLoad',
      header: 'Max Load',
      size: 80,
      cell: ({ row }) => (
        <div className="text-center font-medium">{row.original.maxLoad}</div>
      ),
    },
    {
      accessorKey: 'availablePeriods',
      header: 'Available',
      size: 100,
      cell: ({ row }) => {
        const available = row.original.availablePeriods || 0;
        return (
          <div className={clsx(
            'text-center font-bold',
            available > 0 ? 'text-green-600' : available < 0 ? 'text-red-600' : 'text-gray-900'
          )}>
            {available}
          </div>
        );
      },
    },
    {
      accessorKey: 'preps',
      header: 'Preps',
      size: 80,
      cell: ({ row }) => (
        <div className="text-center">{row.original.preps}</div>
      ),
    },
    {
      accessorKey: 'students',
      header: 'Students',
      size: 80,
      cell: ({ row }) => (
        <div className="text-center font-medium">{row.original.students}</div>
      ),
    },
  ], []);

  // Define dynamic course columns
  const courseColumns = useMemo<ColumnDef<Teacher>[]>(() => {
    return courseGroups
      .filter(group => !state.collapsedCourseGroups.includes(group.id))
      .flatMap(group => {
        return group?.courses?.map((courseName) => ({
          id: `course-${group.id}-${courseName}`,
          header: courseName,
          size: 60,
          meta: {
            courseGroup: group,
          },
          cell: ({ row }: { row: any }) => {
            const teacher = row.original as Teacher;
            const assignment = teacher.assignments.find(
              a => a.courseName === courseName && a.courseGroup === group.id
            );

            if (!assignment) {
              return <div className="text-center text-gray-300">-</div>;
            }

            return (
              <div
                className="flex items-center justify-center rounded px-2 py-1 text-center font-semibold"
                style={{
                  backgroundColor: group.color,
                  color: '#000',
                }}
              >
                {assignment.load}
              </div>
            );
          },
        }));
      });
  }, [courseGroups, state.collapsedCourseGroups]);

  // Combine all columns
  const columns = useMemo(
    () => [...staticColumns, ...courseColumns],
    [staticColumns, courseColumns]
  );

  // Initialize TanStack Table
  const table = useReactTable({
    data: visibleTeachers,
    columns,
    state: {
      sorting,
    },
    onSortingChange: setSorting,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
  });

  // Virtualization setup
  const tableContainerRef = useRef<HTMLDivElement>(null);

  const rowVirtualizer = useVirtualizer({
    count: table.getRowModel().rows.length,
    getScrollElement: () => tableContainerRef.current,
    estimateSize: () => 48,
    overscan: 10,
  });

  const virtualRows = rowVirtualizer.getVirtualItems();
  const totalSize = rowVirtualizer.getTotalSize();

  const paddingTop = virtualRows.length > 0 ? virtualRows[0]?.start || 0 : 0;
  const paddingBottom =
    virtualRows.length > 0
      ? totalSize - (virtualRows[virtualRows.length - 1]?.end || 0)
      : 0;

  return (
    <div className="rounded-lg border border-gray-200 bg-white shadow-sm">
      {/* Division toggles */}
      <div className="flex items-center gap-2 border-b border-gray-200 bg-gray-50 px-4 py-3">
        <span className="text-sm font-medium text-gray-700">Divisions:</span>
        {divisions.map(div => (
          <button
            key={div.division}
            onClick={() => toggleDivision(div.division)}
            className={clsx(
              'rounded-md px-3 py-1 text-sm font-medium transition-colors',
              state.collapsedDivisions.includes(div.division)
                ? 'bg-gray-200 text-gray-500'
                : div.division === 'MS'
                  ? 'bg-green-500 text-white'
                  : 'bg-yellow-500 text-white'
            )}
          >
            {div.label} ({teachers.filter(t => t.division === div.division).length})
          </button>
        ))}

        <div className="ml-auto flex items-center gap-2">
          <span className="text-sm font-medium text-gray-700">Course Groups:</span>
          {courseGroups.map(group => (
            <button
              key={group.id}
              onClick={() => toggleCourseGroup(group.id)}
              className="rounded-md px-2 py-1 text-xs font-medium transition-opacity hover:opacity-80"
              style={{
                backgroundColor: state.collapsedCourseGroups.includes(group.id) ? '#E0E0E0' : group.color,
                color: '#000',
              }}
            >
              {group.name}
            </button>
          ))}
        </div>
      </div>

      {/* Table */}
      <div
        ref={tableContainerRef}
        className="relative overflow-auto"
        style={{ height: 'calc(100vh - 280px)' }}
      >
        <table className="w-full border-collapse">
          <thead className="sticky top-0 z-10 bg-gray-100">
            {table?.getHeaderGroups()?.map(headerGroup => (
              <tr key={headerGroup.id}>
                {headerGroup.headers.map(header => {
                  const meta = header.column.columnDef.meta as { courseGroup?: CourseGroup };
                  const courseGroup = meta?.courseGroup;

                  return (
                    <th
                      key={header.id}
                      style={{
                        width: header.getSize(),
                        backgroundColor: courseGroup ? courseGroup.color : '#F3F4F6',
                      }}
                      className="border border-gray-300 px-2 py-2 text-xs font-semibold text-gray-900"
                    >
                      {header.isPlaceholder ? null : (
                        <div
                          className={clsx(
                            'flex items-center justify-center',
                            header.column.getCanSort() && 'cursor-pointer select-none'
                          )}
                          onClick={header.column.getToggleSortingHandler()}
                        >
                          {flexRender(
                            header.column.columnDef.header,
                            header.getContext()
                          )}
                          {{
                            asc: ' ðŸ”¼',
                            desc: ' ðŸ”½',
                          }[header.column.getIsSorted() as string] ?? null}
                        </div>
                      )}
                    </th>
                  );
                })}
              </tr>
            ))}
          </thead>
          <tbody>
            {paddingTop > 0 && (
              <tr>
                <td style={{ height: `${paddingTop}px` }} />
              </tr>
            )}
            {virtualRows.map(virtualRow => {
              const row = table.getRowModel().rows[virtualRow.index];
              const teacher = row.original;

              return (
                <tr
                  key={row.id}
                  style={{
                    backgroundColor: getDivisionColor(teacher.division),
                  }}
                  className="hover:opacity-90"
                >
                  {row.getVisibleCells().map(cell => (
                    <td
                      key={cell.id}
                      className="border border-gray-300 px-2 py-2 text-sm"
                    >
                      {flexRender(cell.column.columnDef.cell, cell.getContext())}
                    </td>
                  ))}
                </tr>
              );
            })}
            {paddingBottom > 0 && (
              <tr>
                <td style={{ height: `${paddingBottom}px` }} />
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {/* Footer stats */}
      <div className="border-t border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-600">
        Showing {visibleTeachers.length} of {teachers.length} teachers
      </div>
    </div>
  );
}
